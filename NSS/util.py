import numpy as np

MI_CIE_MIN = 400.0
MI_CIE_MAX = 700.0
MI_CIE_SAMPLES = 61

cie_x = np.array([
    0.014310000000, 0.023190000000, 0.043510000000, 0.077630000000,
    0.134380000000, 0.214770000000, 0.283900000000, 0.328500000000,
    0.348280000000, 0.348060000000, 0.336200000000, 0.318700000000,
    0.290800000000, 0.251100000000, 0.195360000000, 0.142100000000,
    0.095640000000, 0.057950010000, 0.032010000000, 0.014700000000,
    0.004900000000, 0.002400000000, 0.009300000000, 0.029100000000,
    0.063270000000, 0.109600000000, 0.165500000000, 0.225749900000,
    0.290400000000, 0.359700000000, 0.433449900000, 0.512050100000,
    0.594500000000, 0.678400000000, 0.762100000000, 0.842500000000,
    0.916300000000, 0.978600000000, 1.026300000000, 1.056700000000,
    1.062200000000, 1.045600000000, 1.002600000000, 0.938400000000,
    0.854449900000, 0.751400000000, 0.642400000000, 0.541900000000,
    0.447900000000, 0.360800000000, 0.283500000000, 0.218700000000,
    0.164900000000, 0.121200000000, 0.087400000000, 0.063600000000,
    0.046770000000, 0.032900000000, 0.022700000000, 0.015840000000,
    0.011359160000
])

cie_y = np.array([
    0.000396000000, 0.000640000000, 0.001210000000, 0.002180000000,
    0.004000000000, 0.007300000000, 0.011600000000, 0.016840000000,
    0.023000000000, 0.029800000000, 0.038000000000, 0.048000000000,
    0.060000000000, 0.073900000000, 0.090980000000, 0.112600000000,
    0.139020000000, 0.169300000000, 0.208020000000, 0.258600000000,
    0.323000000000, 0.407300000000, 0.503000000000, 0.608200000000,
    0.710000000000, 0.793200000000, 0.862000000000, 0.914850100000,
    0.954000000000, 0.980300000000, 0.994950100000, 1.000000000000,
    0.995000000000, 0.978600000000, 0.952000000000, 0.915400000000,
    0.870000000000, 0.816300000000, 0.757000000000, 0.694900000000,
    0.631000000000, 0.566800000000, 0.503000000000, 0.441200000000,
    0.381000000000, 0.321000000000, 0.265000000000, 0.217000000000,
    0.175000000000, 0.138200000000, 0.107000000000, 0.081600000000,
    0.061000000000, 0.044580000000, 0.032000000000, 0.023200000000,
    0.017000000000, 0.011920000000, 0.008210000000, 0.005723000000,
    0.004102000000
])

cie_z = np.array([
    0.067850010000, 0.110200000000, 0.207400000000, 0.371300000000,
    0.645600000000, 1.039050100000, 1.385600000000, 1.622960000000,
    1.747060000000, 1.782600000000, 1.772110000000, 1.744100000000,
    1.669200000000, 1.528100000000, 1.287640000000, 1.041900000000,
    0.812950100000, 0.616200000000, 0.465180000000, 0.353300000000,
    0.272000000000, 0.212300000000, 0.158200000000, 0.111700000000,
    0.078249990000, 0.057250010000, 0.042160000000, 0.029840000000,
    0.020300000000, 0.013400000000, 0.008749999000, 0.005749999000,
    0.003900000000, 0.002749999000, 0.002100000000, 0.001800000000,
    0.001650001000, 0.001400000000, 0.001100000000, 0.001000000000,
    0.000800000000, 0.000600000000, 0.000340000000, 0.000240000000,
    0.000190000000, 0.000100000000, 0.000049999990, 0.000030000000,
    0.000020000000, 0.000010000000, 0.000000000000, 0.000000000000,
    0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
    0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
    0.000000000000
])

cie_wavelengths = np.linspace(MI_CIE_MIN, MI_CIE_MAX, MI_CIE_SAMPLES)

def xyz_to_srgb(X, Y, Z):
    
    # Step 2: Apply the conversion matrix to get linear RGB
    M_xyz_to_srgb = np.array([
        [ 3.240479, -1.537150, -0.498535 ],
        [-0.969256,  1.875991,  0.041556 ],
        [ 0.055648, -0.204043,  1.057311 ]
    ])
    
    # Perform the matrix multiplication with the XYZ values
    linear_rgb = np.dot(M_xyz_to_srgb, [X, Y, Z])

    return linear_rgb

def cie1931_xyz(wavelengths):
    wavelengths = np.asarray(wavelengths)

    x = np.interp(wavelengths, cie_wavelengths, cie_x)
    y = np.interp(wavelengths, cie_wavelengths, cie_y)
    z = np.interp(wavelengths, cie_wavelengths, cie_z)

    return x, y, z

def spectrum_to_xyz(spectrum, wavelengths):
    """
    spectrum   : array of spectral values (same shape as wavelengths)
    wavelengths: array of wavelengths (nm)
    """

    spectrum = np.asarray(spectrum)
    wavelengths = np.asarray(wavelengths)

    x_bar, y_bar, z_bar = cie1931_xyz(wavelengths)

    # If wavelengths are (approximately) uniformly spaced:
    delta_lambda = (wavelengths[-1] - wavelengths[0]) / (len(wavelengths) - 1)

    X = np.sum(x_bar * spectrum) * delta_lambda
    Y = np.sum(y_bar * spectrum) * delta_lambda
    Z = np.sum(z_bar * spectrum) * delta_lambda

    return X, Y, Z